# Top Makefle for Gauche
# $Id: Makefile.in,v 1.50.2.1 2004-12-25 00:34:49 shirok Exp $
#  Run 'configure' script to generate Makefile

.PHONY: all test check pre-package install uninstall \
	clean distclean maintainer-clean install-check

@SET_MAKE@
SHELL       = @SHELL@
prefix      = @prefix@
exec_prefix = @exec_prefix@
bindir      = @bindir@
libdir      = @libdir@
srcdir      = @srcdir@
datadir     = @datadir@

SUBDIRS = gc src lib ext doc
SRIDBUS = doc ext lib src gc
MKINSTDIR = @top_srcdir@/mkinstalldirs
INSTALL = @INSTALL@
GAUCHE_VERSION  = @GAUCHE_VERSION@
GAUCHE_DATA_DIR = $(datadir)/gauche
DESTDIR =

CONFIG_GENERATED = Makefile config.cache config.log config.status libtool \
	           configure.lineno autom4* gc/autom4*
AUTOCONF_GENERATED = $(CONFIG_GENERATED) configure

all:
	for d in $(SUBDIRS); do (cd $$d; $(MAKE) all); done

test : check

check: all
	for d in $(SUBDIRS); do (cd $$d; $(MAKE) check); done

# pre-package target should be run before creating distribution tarball.
# it generates files that requires pre-installed gosh.
pre-package:
	cd src; $(MAKE) pre-package
	cd lib; $(MAKE) pre-package

install: install-pkg install-doc
	cd lib; $(MAKE) slibcat

install-doc:
	cd doc; $(MAKE) install

# it is important to install lib and ext _before_ src, since they
# depend on gosh's rpath to point a valid version of libgauche.so.
install-pkg:
	cd lib; $(MAKE) install
	cd ext; $(MAKE) install
	cd src; $(MAKE) install
	$(INSTALL) -m 444 acinclude.m4 $(DESTDIR)`sh src/gauche-config --ac`/aclocal.m4
	$(MKINSTDIR) $(DESTDIR)$(datadir)/aclocal
	$(INSTALL) -m 444 acinclude.m4 $(DESTDIR)$(datadir)/aclocal/gauche.m4

slibcat-in-place:
	cd lib; $(MAKE) slibcat-in-place

uninstall:
	for d in $(SUBDIRS); do (cd $$d; $(MAKE) uninstall); done
	rm -f $(datadir)/aclocal/gauche.m4

clean:
	rm -rf test.log core *~
	for d in $(SRIDBUS); do (cd $$d; $(MAKE) clean); done

distclean: clean
	for d in $(SRIDBUS); do (cd $$d; $(MAKE) distclean); done
	rm -rf $(CONFIG_GENERATED)

maintainer-clean: clean
	for d in $(SRIDBUS); do (cd $$d; $(MAKE) maintainer-clean); done
	rm -rf $(AUTOCONF_GENERATED) VERSION INSTALL INSTALL.eucjp DIST_EXCLUDE_X gc/configure

dist:
	@echo "To create a distribution tarball, use DIST script."

distcheck:
	@echo "To create a distribution tarball, use DIST script."

install-check:
	@echo "Testing installed Gauche"
	@rm -rf test.log
	@(cd src; $(MAKE) install-check) >> test.log
	@(cd ext; $(MAKE) install-check) >> test.log

# NB: I intentionally make aclocal.m4 not depend on acinclude.m4, to
# prevent aclocal from running accidentally.
aclocal.m4 :
	@echo "************************************************************"
	@echo "To rebuild aclocal.m4 from acinclude.m4, follow the instructions"
	@echo "below:"
	@echo " - Make sure you have libtool 1.5, or you'll be in deep trouble"
	@echo " - Run aclocal"
	@echo " - Edit aclocal.m4 so that always_export_symbols libtool parameter"
	@echo "   shall be 'yes' on cygwin platforms.  (Don't change the default"
	@echo "   value.  There are two occurrences of setting the parameter in"
	@echo "   case statement when the target platform is cygwin.)"
	@echo "************************************************************"


